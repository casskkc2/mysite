<?phpnamespace Home\Event;use Think\Controller;class IssueEvent extends Controller {		public function getIssueList($data) {		$page = isset($data['page']) ? $data['page'] : 0;		$rows = isset($data['rows']) ? $data['rows'] : 0;		$sort = isset($data['sort']) ? $data['sort'] : 'id';		$order_by = isset($data['order']) ? $data['order'] : 'ASC';				$is_advance = isset($data['advance']) ? $data['advance'] : false;				$cond = array(			'city_id' => $data['city_id']		);		if (!$is_advance) {			$cond['area_id'] = array('in', $data['area']);			$cond['target_id'] = array('in', $data['target']);		}				if (!empty($data['keywords'])) {			$arr = explode(' ', preg_replace('/\s{2,}/', ' ', $data['keywords']));			$id_cond = array();			$tags_cond = array();			foreach($arr as $val) {				$tags_cond[] = array('like', '%' . $val . '%');				$id_cond[] = array('eq', $val);			}			!empty($tags_cond) && $tags_cond[] = 'and';			!empty($id_cond) && $id_cond[] = 'or';						$where = array();			!empty($tags_cond) && $where['tags'] = $tags_cond;			!empty($id_cond) && $where['id'] = $id_cond;						if (!empty($where)) {				$where['_logic'] = 'or';				$cond['_complex'] = $where;			}		}		//print_r($cond);exit;		$examine_time_cond = array();		!empty($data['exm_end_date']) && $examine_time_cond[]= array('elt', $data['exm_end_date'] . ' 23:59:59');		!empty($data['exm_start_date']) && $examine_time_cond[]= array('egt', $data['exm_start_date']);		!empty($examine_time_cond) && $cond['examine_time'] = $examine_time_cond;				!empty($data['status_id']) && $cond['status_id'] = $data['status_id'];		!empty($data['is_vp']) && $cond['is_vp'] = $data['is_vp'];		!empty($data['end_date']) && $cond['end_date'] = array('lt', $data['end_date']);				$total = M('Issue')->alias('a')			->where($cond)->count();				if ($rows > 0) {			$start = ($page - 1) * $rows;			$list = M('Issue')->alias('a')				->field('a.*')				->where($cond)				->order($sort . ' ' . $order_by)				->limit($start, $rows)				->select();		}else {			$list = M('Issue')->alias('a')				->field('a.*')				->where($cond)				->order($sort . ' ' . $order_by)				->select();		}		foreach($list as $key=>$row) {			$ts = strtotime($row['examine_time']);			$list[$key]['date'] = date('Y-m-d', $ts);			$list[$key]['time'] = date('H:i', $ts);		}				return array(			'total'=>$total,			'data' => $list		);	}		public function statusToQueryCondition($status, &$data) {		if ($status < 20) {			$data['status_id'] = $status;		}else {			switch($status) {				case 21:					$data['end_date'] = date('Y-m-d');					break;				case 22:					$data['is_vp'] = 1;					break;			}		}	}		public function getIssueDetail($id) {		$cond = array('id'=>$id);		$info = M('Issue')->where($cond)->find();				$ts = strtotime($info['examine_time']);		$info['date'] = date('Y-m-d', $ts);		$info['time'] = date('H:i', $ts);		!empty($info['img']) && $info['img'] = C('HTTP_SERVER') . $info['img'];				return $info;	}		public function getReplyList($issue_id, $type) {		$cond = array('a.issue_id'=>$issue_id);		switch($type) {			case 'text':				$cond['a.type'] = 4;				break;			case 'attachment':				$cond['a.type'] = array('neq', 4);				break;		}				$list = M('IssueReply')->alias('a')			->field('a.*, b.username')			->join('user b ON a.user_id=b.id')			->where($cond)			->select();		foreach($list as $key=>$row) {			if (!empty($row['path'])) {				$list[$key]['path'] = C('HTTP_SERVER') . $row['path'];				$ext = strrchr($row['path']);				$img_types = explode('|', C('ALLOW_IMG_TYPE'));				if ($row['type'] ==2 || in_array($ext, $img_types)) {					$list[$key]['is_img'] = 1;				}				$list[$key]['ext'] = $ext;			}		}				return $list;	}}